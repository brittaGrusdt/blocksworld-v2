---
title: "stats Experiment 1"
output:
  html_document:
    df_print: paged
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(here)
library(scales)
library(tidyverse)
source(here("R", "utils.R"))

# result_dir <-  here("data", "test-runs");
result_dir <- here("data", "prolific", "results", "experiment1")
data_fn <- "exp1_tidy.rds"
path_data <- paste(result_dir, data_fn, sep=.Platform$file.sep)

data <- readRDS(path_data)
```

## Duration

```{r}
df <- data$info %>% group_by(prolific_id) %>% distinct()

p <- df %>%
  ggplot(aes(x=factor(0), y=timeSpent)) + geom_boxplot() + 
  geom_jitter(shape=16) +
  geom_hline(aes(yintercept = mean(df$timeSpent) + sd(df$timeSpent),
                 color="yellow")) +
  geom_hline(aes(yintercept = mean(df$timeSpent) + 2 * sd(df$timeSpent),
                 color="red")) +
  theme(legend.position="none") + 
  labs(x = "", y="timeSpent in min.")
p

df %>% ungroup() %>%  group_by(prolific_id) %>%  summary()
```


```{r, include=FALSE, eval=FALSE, echo=FALSE}
## Train Trials Color Vision

df <- data$color %>% group_by(prolific_id, id) %>%
  mutate(correct = expected == response)

df %>%
  ggplot(aes(x=id)) + geom_bar(position="dodge", aes(fill=correct)) +
  theme(axis.text.x = element_text(angle=90, hjust=1), legend.position = "top")

```

## Train Trials

```{r}
df <- data$train %>% group_by(prolific_id, id)
df.slider <- df %>% filter(trial_name == "animation_slider") 
df.buttons_correct = df %>%
  filter(case_when(expected == "response1" ~ icon_idx == 1,
                   expected == "response2" ~ icon_idx == 2, 
                   expected == "response3" ~ icon_idx == 3,
                   expected == "response4" ~ icon_idx == 4, 
                   ))
# not everyone saw the same trial as slider - trial, therefore sums will not 
# always be exactly the number of participants.
df.buttons_correct %>%
  ggplot(aes(x=id)) + geom_bar(position="dodge", aes(fill=response)) + 
  theme(axis.text.x=element_text(angle=90, hjust=1), legend.position = "top") + 
  guides(fill = guide_legend(title = "correct"))


```


## Reaction times (per experimental trial)

```{r}
df <- data$test %>% select(prolific_id, id, RT) %>% group_by(id) %>% distinct()

# TODO: points are added twice?
RT_mu = df %>% group_by(id) %>% summarise(m=mean(RT), s=sd(RT))
p <- df %>% group_by(id) %>% 
  ggplot(aes(y=RT)) + geom_boxplot() +
  geom_jitter(aes(x=0, color=prolific_id), width = 0.1, alpha = 0.5) +
  geom_hline(data=RT_mu, aes(yintercept = m), color="green", linetype="dashed") +
  geom_hline(data=RT_mu, aes(yintercept = m + s), color="orange") +
  # geom_hline(aes(yintercept = RT_mu + 2 * sd(df$RT)), color="red") +
  theme(legend.position="none", axis.ticks.x = element_blank(), axis.text.x = element_blank()) +
  labs(x="") +
  facet_wrap(~id) + 
  scale_y_continuous(trans = log2_trans(),
                     breaks = trans_breaks("log2", function(x) 2^x),
                     labels = trans_format("log2", math_format(2^.x))) + 
  ggtitle("Reaction times per test stimulus") 
p
```

# Quality of the data
For each participant and trial, compute the distance in RESPONSE to all other participants
and compute the average distance for this participant from all other participants. 

```{r, echo=FALSE}
df <- data$test %>% unite(col = "id_quest", "id", "question", remove=FALSE)
distances <- tibble()
for(proband in df$prolific_id %>% unique()) {
  print(proband)
  res = df %>% filter(prolific_id == proband)
  for(stimulus in df$id %>% unique()) {
    # print(stimulus)
    dat <- df %>% filter(id == stimulus);
    res_proband = res %>% filter(str_detect(string = id_quest, pattern = paste(stimulus, ".*", sep=""))) %>% 
      select(id_quest, response) %>% rename(r_proband = response) %>% 
      add_column(comparator = proband)
    distances <- bind_rows(distances,
                  dat %>% left_join(res_proband, by="id_quest") %>% mutate(diff = r_proband - response)); 
  }
}
```

```{r}
df <- distances %>% filter(comparator != prolific_id) %>%
  group_by(comparator, id, question) %>% mutate(m=mean(diff))

facet_labels <- c(
  `gb` = "Blue and Green", 
  `b` = "Blue but not Green",
  `g` = "Green but not Blue",
  `none` = "Neither Green nor Blue"
);
for(s in df$id %>% unique()) {
 p <- df %>% filter(id == s) %>% select(comparator, question, m, id) %>%
   ungroup() %>% mutate(question = factor(question, levels=c("gb", "b", "g", "none"))) %>% 
   group_by(comparator, question) %>% unique() %>%
   ggplot(aes(y=m, x=factor(0))) +
   geom_boxplot() +
   geom_jitter(aes(color=comparator), width = 0.1, alpha = 0.5) +
   geom_hline(yintercept=0, linetype="dashed", color = "orange", size=.8) +
   scale_y_continuous(limits=c(-1.1, 1.1), breaks=seq(-1, 1, 0.5)) +
   facet_wrap(~question, ncol = 2, labeller = as_labeller(facet_labels)) +
   ggtitle(s) +
   theme(axis.ticks.x = element_blank(), axis.text.x = element_blank(), legend.position="none") +
   labs(y="average difference to other participants' responses", x="")
 print(p)
}
# facet_multiple(plot = p, facets = 'id', ncol = 1, nrow = 1)

  
```



General comments

```{r}
data$comments
data$comments$comments
data$comments$noticed_steepness
```

# Postprocessing
##Filter out participants who did not notice different degrees of inclines

```{r}
filter_prolific_id <- function(df){
  df <- df %>%
    filter(prolific_id != "participant2" & prolific_id != "participant3" &
           prolific_id != "participant11" & prolific_id != "participant13" &
           prolific_id != "participant14")
  print(paste('# filtered out because of not noticing steepness:', "5"))
  return(df)
}

update_data <- function(result_dir){
  target_fn <-"exp1_test_trials_processed.rds";
  target_path <- paste(result_dir, target_fn, sep=.Platform$file.sep);
  df <- readRDS(target_path) %>% filter_prolific_id();
  saveRDS(df, paste(result_dir,
    "exp1_test_trials_processed_steepness_noticed.rds", sep=.Platform$file.sep))
  
  # also update (mean) tables
  tables.all <- df %>% select(id, question, prolific_id, r_norm) %>%
    group_by(id, question, prolific_id) %>%
    pivot_wider(names_from = question, values_from = r_norm)
  write.table(tables.all, file=paste(result_dir,
    "exp1_prob_tables_all_steepness_noticed.csv", sep=.Platform$file.sep),
    sep = ",", row.names=FALSE)
  
  means <- df %>% group_by(id, question) %>% summarise(mean=mean(r_norm))
  write.table(means %>% pivot_wider(names_from = question, values_from = mean),
              file=paste(result_dir, "exp1_prob_tables_mean_steepness_noticed.csv", sep=.Platform$file.sep),
              sep = ",", row.names=FALSE)
}

update_data(result_dir);

```

